# =============================================================================
# Docker Compose — Support Ticket System
# =============================================================================
# Run the entire stack: docker-compose up --build
#
# Services:
#   db       — PostgreSQL 16 (data persisted in a named volume)
#   backend  — Django + Gunicorn (auto-migrates on startup)
#   frontend — React app served via Nginx (proxies /api to backend)
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # PostgreSQL Database
  # ---------------------------------------------------------------------------
  db:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: tickets_db
      POSTGRES_USER: tickets_user
      POSTGRES_PASSWORD: tickets_password
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U tickets_user -d tickets_db"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    ports:
      - "5432:5432"

  # ---------------------------------------------------------------------------
  # Django Backend (Gunicorn)
  # ---------------------------------------------------------------------------
  backend:
    build: ./backend
    depends_on:
      db:
        condition: service_healthy
    environment:
      - POSTGRES_DB=tickets_db
      - POSTGRES_USER=tickets_user
      - POSTGRES_PASSWORD=tickets_password
      - POSTGRES_HOST=db
      - POSTGRES_PORT=5432
      - DJANGO_SECRET_KEY=django-insecure-change-this-in-production
      - DJANGO_SETTINGS_MODULE=config.settings.production
      - DJANGO_ALLOWED_HOSTS=localhost,127.0.0.1,backend
      - GEMINI_API_KEY=${GEMINI_API_KEY:-}
      - GUNICORN_WORKERS=3
    ports:
      - "8000:8000"
    stop_grace_period: 30s    # Matches gunicorn graceful_timeout
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # React Frontend (Nginx)
  # ---------------------------------------------------------------------------
  frontend:
    build: ./frontend
    depends_on:
      - backend
    ports:
      - "3000:80"
    restart: unless-stopped

# =============================================================================
# Persistent Volumes
# =============================================================================
volumes:
  postgres_data:
